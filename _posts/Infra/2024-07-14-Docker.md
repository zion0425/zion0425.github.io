---
title: Docker
date: 2024-07-14
categories: [Infra]
tags: [docker]
---

간혹 맥북을 사용하는 친구들이 맥북이 불편하다며 윈도우를 깔아서 작업하는 광경을 볼 수 있습니다. 이 과정에서 사용하는 기술을 **가상머신(Virtual Machine, VM)이라고 합니다.**

**가상머신**은 **하이퍼바이저**라는 소프트웨어를 사용하여 호스트의 하드웨어 자원을 가상화하고, 여러 가상 운영 체제를 실행할 수 있게 합니다. 즉, 하이퍼바이저는 호스트 시스템의 하드웨어 자원을 분리하여 각각의 가상머신에 할당하고, 각 가상머신에 운영 체제를 별도로 설치해야 합니다.

반면, **도커**는 **컨테이너화(Containerization)** 기술을 사용하여 애플리케이션을 가볍고 효율적으로 실행합니다. 도커는 호스트 운영 체제의 **커널**을 공유하면서 애플리케이션을 독립된 환경에서 실행할 수 있도록 합니다. 이렇게 함으로써, 도커는 가상머신보다 더 적은 자원으로 애플리케이션을 실행할 수 있게 됩니다.

*여기서 "가상화"란 자원을 독립적인 환경처럼 보이게 만들어주는 기술을 의미합니다.*

도커에서는 애플리케이션을 **이미지(Image)**라는 형태로 패키징하며, 이는 마치 애플리케이션의 설계도와 같습니다. 이 이미지를 실제로 실행 가능한 환경으로 변환한 것이 **컨테이너(Container)**입니다. 즉, 이미지를 컨테이너로 변환하여 실행합니다. 
그리고 이러한 이미지는 이미 많은 사람들이 생성해 놓았기 때문에, 우리는 기존의 이미지를 감사하게 가져다 사용하면 됩니다.

## 도커 설치

도커를 설치하기 위해서는 [도커 공식 홈페이지](https://docs.docker.com/get-docker/)를 참고하시기 바랍니다.

`EC2`의 `Amazon Linux 2 AMI`를 사용하는 경우, 아래의 명령어를 통해 도커를 설치할 수 있습니다.

```bash 
sudo yum update -y
sudo amazon-linux-extras install docker
sudo service docker start
sudo usermod -a -G docker ec2-user
```

위에서 `usermod` 명령어를 통해 `ec2-user`를 `docker` 그룹에 추가하였습니다. 이는 `ec2-user`가 `sudo` 권한을 가지고 있기 때문에, `docker` 명령어를 사용할 때마다 `sudo`를 입력하지 않아도 되도록 하기 위함입니다.

이를 적용하기 위해 인스턴스를 재부팅합니다.

```bash
sudo reboot
```

### Yum 명령어 사용 시 주의사항

간혹 `yum` 명령어를 사용할 때 여러 커맨드를 한 번에 입려갛다가 미처 종료되지 않은 프로세스가 남아 에러가 발생하는 경우가 있습니다. 이 때는 아래의 명령어를 통해 해당 프로세스를 종료하고 다시 설치를 시도합니다.

```bash
ps -ef | grep yum
sudo kill -9 [PID]
```

## 가상 메모리 할당

`Jenkins`는 기본적으로 많은 메모리를 사용합니다. 하지만 `Free Tier`에서 제공하는 `EC2` 인스턴스는 메모리가 1GB로 제한적이기 때문에, `Jenkins`를 실행하기 위해서는 가상 메모리를 할당해야 합니다. 

실제로 `1GB`로 젠킨스 빌드를 시도해 본 결과, 3시간 이상이 걸리거나 젠킨스 서버가 다운되는 문제가 발생했습니다.

이를 해결하기 위해 `EC2` 인스턴스에 `Swap` 메모리를 할당하면, `EC2` 인스턴스의 메모리를 확장할 수 있습니다.

```bash
sudo dd if=/dev/zero of=/swapfile bs=128M count=16
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
sudo swapon -s
```

`sudo swapon -s` 명령어를 통해 `Swap` 메모리가 할당되었는지 확인합니다.

`vi /etc/fstab` 명령어를 통해 해당 파일에 아래의 내용을 추가합니다.

```bash
/swapfile swap swap defaults 0 0
```

이 명령어는 `Swap` 메모리가 인스턴스가 재부팅될 때마다 자동으로 할당되도록 하는 명령어입니다.

최종적으로 `free -h` 명령어를 통해 메모리가 할당되었는지 확인합니다.

### 한계점

하지만 이러한 방법은 `EC2` 인스턴스의 메모리를 확장하는 것이 아니라, `Swap` 메모리를 할당하는 것이기 때문에, `Swap` 메모리는 `EC2` 인스턴스의 메모리보다 느리다는 점을 유의해야 합니다.

실제로 해당 방법을 통해 `Jenkins` 빌드 시간이 4 ~ 6분으로 단축되었지만, 여전히 빌드 시간이 길다는 문제가 남아있습니다.

빌드 최적화나 `Jenkins` 설정을 통해 빌드 시간을 단축할 수 있지만, 이러한 문제의 본질적인 이유는 `EC2` 인스턴스의 메모리 한계로 인해 발생하는 문제입니다.

이는 `Scaling`을 통해 해결할 수 있습니다. `Scale Out`이나 `Scale Up`을 통해 해결할 수 있습니다.

단순하게 `Scale Up`을 통해 1 ~ 3분이라는 빌드 시간을 얻을 수 있었습니다.